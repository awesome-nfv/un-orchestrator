
# Elastic Router Deployment

The elastic router use case uses these config files:

* `universal-node-er-demo.xml` : defines the external interface (SAPs) that are connected to the UN 

* `orchestrator_config_er_demo.ini` : init file for the UN. Uses the above described config file and defines which nffg to deploy at startup.

* `name_resolver_config_er_demo.xml` : config file for the name resolver. Contains the definition and link the `ctrl` and `ovs` docker images (at repository gitlab.testbed.se:5000/ or build locally first).

* `nffg_files/er_nffg.json` : The elastic router NFFG to be deployed (ctrl + 1 ovs instance)  

* `start_veth` : This script that starts 4 linux namespaces (sap1, sap2, sap3, sap4). The namespaces are connected via veth pairs to the UN. These namespaces each have their own IP and MAC and can be used to generate traffic through the elastic router. 
Traffic can be generated by (ping from sap3 to 10.0.4.1):

               ip netns exec sap3 ping 10.0.4.1


![Elastic Router](https://raw.githubusercontent.com/stevenvanrossem/un-orchestrator/elastic-router/use-cases/elastic_router/elastic_router_files/figures/ER_test_setup.PNG)



* `ryu_app/elastic_router_config.json` : This file contains the routing table configuration of the elastic router, linking each sap to a subnet. This is used to populate the flow entries in the `ovs` containers. This file is located here: `un-orchestrator/NFs/docker/elastic-router/ctrl_app/ryu_app`

* `start_UN` : This script starts the above described NFFG.

# Test procedure

First build the elastic router docker containers locally:

* The ovs dataplane containers: 

`sudo docker build --tag="gitlab.testbed.se:5000/ovs"  .`

* The control app that will scale the dataplane containers:

`sudo docker build --tag="gitlab.testbed.se:5000/ctrl" -f Dockerfile_no_DD .`

Note: this builds the container without DoubleDecker support


Next steps:

1. go to the correct directory:  `cd /un-orchestrator/use-cases/elastic_router/elastic_router_files`
2. start the namespaces: `./start_veth`
3. start the elastic router: `./start_UN`
4. generate some traffic (from other terminal): `ip netns exec sap3 ping 10.0.4.1` 

You can check the flow-tables of the deployed ovs container via remotely ssh login or locally via the docker command:

    docker exec -it 2_ovs1 ovs-ofctl dump-flows ovs1
    
The Orchestrator of the UN has now deployed a Control App (`ctrl` container) and a Data Path (`ovs` container).
The elastic router control app deployed in the `ctrl` container has a rest api exposed at port 9000, which can be used to manually trigger a scale action via the Cf-Or interfac eof the UN orchestrator:

* `curl -X GET localhost:9000/scale/out` triggers a scale out action and scales the elasticr router to 4 data path containers instead of one.

* `curl -x GET localhost:9000/scale/in` triggers a scale in action and deploys again one data path container.
